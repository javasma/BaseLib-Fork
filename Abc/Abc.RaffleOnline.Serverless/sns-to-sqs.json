{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "SNS To SQS fanout",
    "Resources": {
        "CoreEventsTopic": {
            "Type": "AWS::SNS::Topic",
            "Properties": {
                "TopicName": "raffle-core-events-topic.fifo",
                "FifoTopic": true
            }
        },
        "JournalEventsSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "Endpoint": {
                    "Fn::GetAtt": [
                        "JournalEventsQueue",
                        "Arn"
                    ]
                },
                "Protocol": "sqs",
                "TopicArn": {
                    "Ref": "CoreEventsTopic"
                }
            }
        },
        "BillingOnOpenRaffleSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "Endpoint": {
                    "Fn::GetAtt": [
                        "BillingOnOpenRaffleQueue",
                        "Arn"
                    ]
                },
                "Protocol": "sqs",
                "FilterPolicy": {
                    "ServiceName": [
                        "OpenRaffleService"
                    ],
                    "Status": [
                        "Finished"
                    ]
                },
                "TopicArn": {
                    "Ref": "CoreEventsTopic"
                }
            }
        },
        "JournalEventsQueue": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "QueueName": "raffle-journal-events-queue.fifo",
                "FifoQueue": true
            }
        },
        "JournalEventsQueuePolicy": {
            "Type" : "AWS::SQS::QueuePolicy",
            "Properties": {
                "Queues": [
                    {
                        "Ref": "JournalEventsQueue"
                    }
                ],
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "sns.amazonaws.com"
                            },
                            "Action": "sqs:SendMessage",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "JournalEventsQueue",
                                    "Arn"
                                ]
                            },
                            "Condition": {
                                "ArnEquals": {
                                    "aws:SourceArn": {
                                        "Ref": "CoreEventsTopic"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        },
        "BillingOnOpenRaffleQueue": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "QueueName": "raffle-billing-on-open-queue.fifo",
                "FifoQueue": true
            }
        },
        "BillingOnOpenRaffleQueuePolicy": {
            "Type" : "AWS::SQS::QueuePolicy",
            "Properties": {
                "Queues": [
                    {
                        "Ref": "BillingOnOpenRaffleQueue"
                    }
                ],
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "sns.amazonaws.com"
                            },
                            "Action": "sqs:SendMessage",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "BillingOnOpenRaffleQueue",
                                    "Arn"
                                ]
                            },
                            "Condition": {
                                "ArnEquals": {
                                    "aws:SourceArn": {
                                        "Ref": "CoreEventsTopic"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        }
    },
    "Outputs": {
        "EventsTopic": {
            "Value": {
                "Ref": "CoreEventsTopic"
            }
        }
    }
}